<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Acuarela CRM</title>

    <link rel="apple-touch-icon" sizes="57x57" href="icon/apple-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="60x60" href="icon/apple-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="72x72" href="icon/apple-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="76x76" href="icon/apple-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="114x114" href="icon/apple-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="120x120" href="icon/apple-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="144x144" href="icon/apple-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="152x152" href="icon/apple-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="icon/apple-icon-180x180.png">
    <link rel="icon" type="imageicon/png" sizes="192x192" href="icon/android-icon-192x192.png">
    <link rel="icon" type="imageicon/png" sizes="32x32" href="icon/favicon-32x32.png">
    <link rel="icon" type="imageicon/png" sizes="96x96" href="icon/favicon-96x96.png">
    <link rel="icon" type="imageicon/png" sizes="16x16" href="icon/favicon-16x16.png">
    <link rel="manifest" href="icon/manifest.json">
    <meta name="msapplication-TileColor" content="#ffffff">
    <meta name="msapplication-TileImage" content="icon/ms-icon-144x144.png">
    <meta name="theme-color" content="#ffffff">
    <script src="https://cdn.tailwindcss.com"></script>
    <meta property="og:title" content="Acuarela Design Studio CRM - Gestión de Proyectos" />

    <meta property="og:description"
        content="Herramienta interna de gestión de clientes (CRM), proyectos, pagos y comunicación, diseñada para la estética Acuarela." />

    <meta property="og:url" content="https://acuarelacrm.netlify.app/" />

    <meta property="og:image" content="img/link.webp" />
    <meta property="og:image:width" content="1200" />
    <meta property="og:image:height" content="630" />
    <meta property="og:type" content="website" />
    <meta property="og:site_name" content="Acuarela Design Studio CRM" />
    <meta property="og:locale" content="es_ES" />

    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:domain" content="https://acuarelacrm.netlify.app/" />
    <meta name="twitter:url" content="https://acuarelacrm.netlify.app/" />
    <meta name="twitter:title" content="Acuarela Design Studio CRM - Gestión de Proyectos" />
    <meta name="twitter:description"
        content="Herramienta interna para Acuarela Design Studio. Gestiona proyectos, clientes y saldos pendientes de forma eficiente." />
    <meta name="twitter:image" content="img/link.webp" />

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');

        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fb;
            /* Fondo muy claro y suave */
        }

        /* Estilos base del CRM */
        .card {
            background-color: white;
            border-radius: 12px;
            transition: transform 0.1s ease-in-out;
        }

        .btn-primary {
            background-color: #0ea5e9;
            /* Sky-500 (Azul Acuarela) */
            color: white;
            padding: 8px 16px;
            border-radius: 8px;
            font-weight: 600;
            transition: background-color 0.15s;
        }

        .btn-primary:hover {
            background-color: #0284c7;
            /* Sky-600 */
        }

        .status-badge {
            font-size: 0.75rem;
            padding: 2px 8px;
            border-radius: 9999px;
            font-weight: 500;
        }

        .nav-link-active {
            background-color: #ebf8ff;
            /* Lightest blue */
            color: #0ea5e9;
        }

        /* Estilos AÑADIDOS para las tarjetas de Dashboard al estilo Acuarela */
        .watercolor-card {
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            color: #1f2937;
            font-weight: 600;
        }

        .wc-green {
            background: url('img/azul-acuarela.png');
            background-size: cover;
            background-position: center;
        }

        .wc-orange {
            background: url('img/verde-acuarela.png');
            background-size: cover;
            background-position: center;
        }

        .wc-blue {
            background: url('img/melon-acuarela.png');
            background-size: cover;
            background-position: center;
        }

        .wc-value {
            font-size: 2.25rem;
            font-weight: 800;
            margin-top: 4px;
        }

        .wc-title {
            font-size: 0.875rem;
            font-weight: 700;
            letter-spacing: 0.05em;
            text-transform: uppercase;
        }

        .title-badge {
            display: inline-flex;
            align-items: center;
            padding: 2px 10px;
            margin-left: 8px;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 700;
            background-color: #f3f4f6;
            color: #4b5563;
        }

        /* === ESTILOS DE LA PLANTILLA ADADW.HTML INTEGRADOS === */
        /* Contenedor del avatar en vista de detalle (Grande) */
        .avatar-container {
            position: relative;
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 4px;
            box-shadow: 0 8px 24px rgba(102, 126, 234, 0.3);
            flex-shrink: 0;
        }

        /* Contenedor interno del avatar en vista de detalle (Grande) */
        .avatar-inner {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
            font-weight: 700;
            color: #667eea;
            overflow: hidden;
            /* Para las imágenes de Base64 */
        }

        .avatar-inner img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .btn-whatsapp {
            background: linear-gradient(135deg, #25D366 0%, #128C7E 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(37, 211, 102, 0.3);
            padding: 12px 24px;
            border-radius: 12px;
            font-weight: 600;
            font-size: 15px;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
        }

        .btn-secondary-custom {
            background: white;
            border: 2px solid #e5e7eb;
            color: #0ea5e9;
            padding: 12px 24px;
            border-radius: 12px;
            font-weight: 600;
            font-size: 15px;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        }

        .metric-card {
            padding: 24px;
            border-radius: 16px;
            background: linear-gradient(135deg, #667eea15 0%, #764ba215 100%);
            border: 2px solid #667eea30;
            transition: all 0.3s ease;
        }

        .metric-card .icon-bg {
            padding: 12px;
            border-radius: 12px;
        }

        /* Badges de Estado del Cliente */
        .badge-success-client {
            background: #d1fae5;
            color: #065f46;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
        }

        .badge-inactive-client {
            background: #fee2e2;
            color: #991b1b;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
        }

        /* Estilos de Pestañas de Proyectos */
        .nav-link-project {
            padding: 10px 16px;
            font-weight: 500;
            border-bottom: 2px solid transparent;
            transition: all 0.2s ease;
            cursor: pointer;
            color: #6b7280;
            outline: none;
        }

        .nav-link-project.active {
            font-weight: 600;
            color: #0ea5e9;
            border-bottom-color: #0ea5e9;
        }

        /* Estilos de Tarjeta de Proyecto */
        .project-card-link {
            display: block;
            text-decoration: none;
            color: inherit;
        }

        .project-content-detail {
            display: flex;
            gap: 16px;
            align-items: stretch;
        }

        .project-image-detail {
            width: 120px;
            height: 120px;
            min-width: 120px;
            border-radius: 1.5rem;
            object-fit: cover;
            flex-shrink: 0;
            background-color: #e5e7eb;
        }

        .project-details-row {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }

        .project-details-row span {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.875rem;
            color: #4b5563;
        }

        /* Badges de Estado del Proyecto */
        .badge-project-status {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            border-radius: 9999px;
            font-size: 0.875rem;
            font-weight: 600;
            transition: all 0.2s ease;
        }

        .status-Pendiente_de_inicio {
            background: #dbeafe;
            color: #1e40af;
        }

        /* Azul pastel - Info */
        .status-En_proceso {
            background: #fef3c7;
            color: #92400e;
        }

        /* Amarillo pastel - Proceso */
        .status-Pendiente_de_pago {
            background: #fce7f3;
            color: #be185d;
        }

        /* Rosa pastel - Alerta */
        .status-Por_entregar {
            background: #e0f2fe;
            color: #0284c7;
        }

        /* Azul claro - Listo */
        .status-Entregado {
            background: #d1fae5;
            color: #065f46;
        }

        /* Verde pastel - Éxito */
        .status-Cancelado {
            background: #e5e7eb;
            color: #4b5563;
        }

        /* Gris - Cancelado */

        /* Media Queries para responsividad */
        @media (max-width: 767px) {
            .avatar-container {
                width: 90px;
                height: 90px;
            }

            .avatar-inner {
                font-size: 2.5rem;
            }

            .project-image-detail {
                width: 90px;
                min-width: 90px;
                height: 90px;
            }

            .project-content-detail {
                flex-direction: column;
                align-items: flex-start;
            }

            .project-details-row {
                flex-direction: column;
                gap: 8px;
            }

            .btn-whatsapp,
            .btn-secondary-custom {
                width: 100%;
                justify-content: center;
            }

            .watercolor-card {
                border-radius: 8px;
                padding: 8px;
                text-align: center;
                color: #1f2937;
                font-weight: 600;
            }

            .wc-value {
                font-size: 1rem;
                font-weight: 800;
                margin-top: 4px;
            }

            .wc-title {
                font-size: .6rem;
                font-weight: 700;
                letter-spacing: 0.05em;
                text-transform: uppercase;
            }

            .title-badge {
                display: inline-flex;
                align-items: center;
                padding: 2px 10px;
                margin-left: 8px;
                border-radius: 9999px;
                font-size: 0.5rem;
                font-weight: 700;
                background-color: #f3f4f6;
                color: #4b5563;
            }
        }
    </style>
</head>

<body class="min-h-screen">

    <div class="flex min-h-screen bg-[#f7f9fb]">

        <aside id="sidebar"
            class="w-64 fixed top-0 left-0 h-full bg-white shadow-xl z-50 p-4 flex-col transition-transform transform -translate-x-full lg:flex lg:translate-x-0">

            <button class="absolute top-4 right-4 lg:hidden text-gray-500 hover:text-gray-800"
                onclick="toggleSidebar()">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12">
                    </path>
                </svg>
            </button>

            <div class="py-4 mb-6 border-b border-gray-100 flex items-center">
                <img src="img/311449776_615059936938111_2931967811620169613_n.jpg" alt="Logo Acuarela"
                    class="rounded-lg mr-2">
            </div>

            <nav id="main-navigation" class="space-y-2 flex-grow">
                <button id="nav-dashboard"
                    class="nav-link w-full text-left p-3 rounded-lg text-gray-600 font-medium flex items-center space-x-3 hover:bg-[#ebf8ff] hover:text-[#0ea5e9] transition"
                    onclick="navigate('dashboard')">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                        xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6">
                        </path>
                    </svg>
                    <span>Dashboard</span>
                </button>
                <button id="nav-client_list"
                    class="nav-link w-full text-left p-3 rounded-lg text-gray-600 font-medium flex items-center space-x-3 hover:bg-[#ebf8ff] hover:text-[#0ea5e9] transition"
                    onclick="navigate('client_list')">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                        xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20v-2a3 3 0 015.356-1.857M7 20h4m-4 0v-2c0-.656-.126-1.283-.356-1.857M7 20H4a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z">
                        </path>
                    </svg>
                    <span>Clientes</span>
                </button>
                <button id="nav-settings"
                    class="nav-link w-full text-left p-3 rounded-lg text-gray-600 font-medium flex items-center space-x-3 hover:bg-[#ebf8ff] hover:text-[#0ea5e9] transition"
                    onclick="navigate('settings')">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                        xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.942 3.321.815 2.573 2.573a1.724 1.724 0 001.066 2.573c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.942 1.543-.815 3.321-2.573 2.573a1.724 1.724 0 00-2.573 1.066c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.942-3.321-.815-2.573-2.573a1.724 1.724 0 00-1.066-2.573c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.942-1.543.815 3.321 2.573-2.573a1.724 1.724 0 002.573-1.066z">
                        </path>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                    </svg>
                    <span>Ajustes</span>
                </button>
            </nav>

            <div class="mt-auto pt-4 border-t border-gray-100">
                <button class="btn-primary w-full flex items-center justify-center space-x-2"
                    onclick="checkForClientsBeforeProject()">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                        xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                    </svg>
                    <span>Nuevo Proyecto</span>
                </button>
            </div>
        </aside>

        <div id="sidebar-overlay" class="fixed inset-0 bg-black opacity-50 z-40 hidden lg:hidden"
            onclick="toggleSidebar()"></div>


        <div id="main-content-wrapper" class="flex-grow lg:ml-64 flex flex-col w-full">

            <button class="fixed top-2 left-4 z-30 lg:hidden p-2 bg-white rounded-lg shadow-md" style="margin: 8px;"
                onclick="toggleSidebar()">
                <svg class="w-6 h-6 text-gray-700"  fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16">
                    </path>
                </svg>
            </button>

            <header id="main-header"
                class="w-full h-20 bg-cover bg-center relative lg:pl-0 pl-16 flex items-center justify-between px-6"
                style="background-image: url('img/header.png');">

                <div class="relative z-10 text-white font-bold text-2xl hidden md:block">
                    Acuarela CRM
                </div>

                <div id="header-content" class="relative z-10 text-white flex-1 flex justify-center items-center">
                </div>

                <div class="relative z-10 ml-4">
                    <img src="https://placehold.co/40x40/77c3e7/ffffff?text=U" alt="Usuario"
                        class="w-10 h-10 rounded-full border-2 border-white object-cover">
                </div>

            </header>

            <main class="flex-grow w-full p-4 sm:p-6 lg:p-8 max-w-7xl mx-auto">
                <div id="view-container">
                    <div class="text-center p-20 text-gray-500">Cargando aplicación...</div>
                </div>

                <div id="modal-container"
                    class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50">
                    <div class="card p-6 w-full max-w-sm">
                        <h3 id="modal-title" class="text-xl font-bold mb-4">Título</h3>
                        <p id="modal-message" class="text-gray-600 mb-6">Mensaje</p>
                        <div class="flex justify-end space-x-3">
                            <button id="modal-cancel-btn"
                                class="px-4 py-2 text-gray-600 rounded-md hover:bg-gray-100 transition">Cancelar</button>
                            <button id="modal-action-btn" class="btn-primary">Aceptar</button>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <script>
        // ====================================================================
        // 1. ESTRUCTURA DE DATOS Y UTILIDADES DE ALMACENAMIENTO (localStorage)
        // ====================================================================
        const STORAGE_KEY = 'acuarela_crm_data';

        let state = {
            clients: [],
            projects: [],
            payments: [],
            settings: {},
            currentView: 'dashboard',
            currentClientId: null,
            currentProjectId: null,
            sortKey: 'creationDate',
            sortDir: 'desc',
            searchTerm: '',
        };

        const PROJECT_STATUSES = [
            'Pendiente de inicio',
            'En proceso',
            'Pendiente de pago',
            'Por entregar',
            'Entregado',
            'Cancelado'
        ];

        // Mensajes de WhatsApp predeterminados
        const DEFAULT_MESSAGES = {
            'Pendiente de inicio': 'Hola [NOMBRE_CLIENTE], te escribo para confirmar que hemos agendado tu proyecto "[NOMBRE_PROYECTO]". Estaremos en contacto pronto para iniciar. ¡Gracias por confiar en Acuarela!',
            'En proceso': 'Hola [NOMBRE_CLIENTE], te informo que tu proyecto "[NOMBRE_PROYECTO]" está actualmente en proceso de diseño/elaboración. Te mantendremos al tanto de cualquier avance. Saludos.',
            'Pendiente de pago': 'Hola [NOMBRE_CLIENTE], tu proyecto "[NOMBRE_PROYECTO]" está finalizado y listo para la entrega. El saldo pendiente es de [SALDO_PENDIENTE]. Una vez recibido el pago, procederemos a enviarte los archivos finales. ¡Gracias!',
            'Por entregar': 'Hola [NOMBRE_CLIENTE], tu proyecto "[NOMBRE_PROYECTO]" ya está pagado y listo. Por favor, confirma por qué medio deseas la entrega de los archivos finales.',
            'Entregado': 'Hola [NOMBRE_CLIENTE], tu proyecto "[NOMBRE_PROYECTO]" ha sido entregado exitosamente. ¡Muchas gracias por tu preferencia!',
            'Cancelado': 'Hola [NOMBRE_CLIENTE], tu proyecto "[NOMBRE_PROYECTO]" ha sido marcado como cancelado.',
        };

        /**
         * Inicializa o carga los datos desde localStorage.
         */
        function loadData() {
            try {
                const data = JSON.parse(localStorage.getItem(STORAGE_KEY));
                if (data) {
                    state.clients = data.clients || [];
                    state.projects = data.projects || [];
                    state.payments = data.payments || [];
                    state.settings = {
                        ...DEFAULT_MESSAGES,
                        ...(data.settings || {})
                    };
                } else {
                    state.settings = DEFAULT_MESSAGES;
                    saveData();
                }
            } catch (e) {
                console.error("Error al cargar datos:", e);
                // Si falla, inicializa con defaults
                state.settings = DEFAULT_MESSAGES;
            }
            console.log("Datos cargados:", state);
        }

        /**
         * Guarda el estado actual en localStorage.
         */
        function saveData() {
            const dataToSave = {
                clients: state.clients,
                projects: state.projects,
                payments: state.payments,
                settings: state.settings,
            };
            localStorage.setItem(STORAGE_KEY, JSON.stringify(dataToSave));
        }

        /**
         * Actualiza la clase activa en los botones de navegación.
         */
        function updateActiveClass(view) {
            document.querySelectorAll('.nav-link').forEach(btn => {
                btn.classList.remove('nav-link-active');
                btn.classList.remove('text-[#0ea5e9]');
                btn.classList.add('text-gray-600');
            });
            const activeBtn = document.getElementById(`nav-${view}`);
            if (activeBtn) {
                activeBtn.classList.add('nav-link-active');
                activeBtn.classList.add('text-[#0ea5e9]');
                activeBtn.classList.remove('text-gray-600');
            }
        }


        /**
         * Navega a una nueva vista y fuerza el renderizado.
         * @param {string} view - Nombre de la vista ('dashboard', 'client_detail', etc.)
         * @param {string|null} clientId - ID del cliente (opcional)
         * @param {string|null} projectId - ID del proyecto (opcional)
         */
        function navigate(view, clientId = null, projectId = null) {
            state.currentView = view;
            state.currentClientId = clientId;
            state.currentProjectId = projectId;
            updateActiveClass(view); // Actualiza el estilo del menú
            renderApp();
            window.scrollTo(0, 0); // Desplaza al inicio de la página

            // Oculta el sidebar si estamos en móvil y navegamos
            if (window.innerWidth < 1024) {
                const sidebar = document.getElementById('sidebar');
                if (!sidebar.classList.contains('-translate-x-full')) {
                    toggleSidebar();
                }
            }
        }

        /**
         * Función para mostrar/ocultar el sidebar en móvil.
         */
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebar-overlay');

            sidebar.classList.toggle('-translate-x-full');
            overlay.classList.toggle('hidden');
        }

        /**
         * Verifica si hay clientes antes de intentar crear un proyecto.
         */
        function checkForClientsBeforeProject() {
            if (state.clients.length === 0) {
                showModal('Crear Cliente Primero', 'No hay clientes registrados. Debes crear un cliente antes de asignarle un proyecto.', false).then(() => {
                    navigate('create_client');
                });
            } else {
                navigate('create_project');
            }
        }

        // ====================================================================
        // 2. LÓGICA DE NEGOCIO Y CÁLCULOS
        // ====================================================================

        /**
         * Calcula el saldo pendiente y el total abonado para un proyecto.
         * @param {string} projectId - ID del proyecto.
         * @returns {{totalPaid: number, balance: number}}
         */
        function calculateProjectBalance(projectId) {
            const project = state.projects.find(p => p.id === projectId);
            if (!project) return {
                totalPaid: 0,
                balance: 0
            };

            const totalPaid = state.payments
                .filter(p => p.projectId === projectId)
                .reduce((sum, payment) => sum + parseFloat(payment.amount), 0);

            const balance = parseFloat(project.totalPrice) - totalPaid;
            return {
                totalPaid: parseFloat(totalPaid.toFixed(2)),
                balance: parseFloat(balance.toFixed(2))
            };
        }

        /**
         * Genera un color pastel aleatorio.
         * Fuente: https://stackoverflow.com/a/43235760/910023
         */
        const generatePastelColor = (seed) => {
            let hash = 0;
            for (let i = 0; i < seed.length; i++) {
                hash = seed.charCodeAt(i) + ((hash << 5) - hash);
            }
            const h = hash % 360;
            // Usamos saturación y luminosidad bajas para el efecto pastel
            return `hsl(${h}, 55%, 75%)`;
        };

        /**
         * Genera el HTML para el avatar del cliente (foto o inicial).
         * @param {Object} client Objeto cliente.
         * @param {string} size - Clases de Tailwind para width y height (ej: 'w-10 h-10', 'w-full h-full').
         * @returns {string} HTML del avatar.
         */
        const getClientAvatarHtml = (client, size = 'w-10 h-10') => {
            const initial = client.name.charAt(0).toUpperCase();
            const color = generatePastelColor(client.name);
            const classes = size.includes('120px') ? '' : 'shadow-md'; // Solo sombra si es el pequeño

            if (client.photoBase64) {
                // Si tiene foto, la mostramos dentro de un div con las clases de tamaño
                return `
                    <div class="${size} rounded-full overflow-hidden flex-shrink-0 ${classes}">
                        <img src="${client.photoBase64}" alt="${initial} Avatar" class="w-full h-full object-cover">
                    </div>
                `;
            } else {
                // Si no tiene foto, mostramos la inicial con color pastel
                return `
                    <div class="${size} rounded-full flex items-center justify-center font-bold text-lg text-white flex-shrink-0 ${classes}" 
                         style="background-color: ${color};">
                        ${initial}
                    </div>
                `;
            }
        };

        /**
         * Redimensiona la imagen y la convierte a Base64 (800x800).
         * @param {File} file Archivo de imagen subido.
         * @returns {Promise<string|null>} Base64 de la imagen redimensionada o null.
         */
        const resizeImageAndConvertToBase64 = (file) => {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = function (e) {
                    const img = new Image();
                    img.onload = function () {
                        const canvas = document.createElement('canvas');
                        const MAX_SIZE = 800;
                        let width = img.width;
                        let height = img.height;

                        // Redimensionamiento básico manteniendo aspecto y máximo 800x800
                        if (width > height) {
                            if (width > MAX_SIZE) {
                                height *= MAX_SIZE / width;
                                width = MAX_SIZE;
                            }
                        } else {
                            if (height > MAX_SIZE) {
                                width *= MAX_SIZE / height;
                                height = MAX_SIZE;
                            }
                        }

                        canvas.width = width;
                        canvas.height = height;

                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        const dataUrl = canvas.toDataURL('image/jpeg', 0.8); // 80% calidad
                        resolve(dataUrl);
                    };
                    img.src = e.target.result;
                };
                reader.onerror = () => resolve(null);
                reader.readAsDataURL(file);
            });
        };

        /**
         * Genera el enlace de WhatsApp con el mensaje predefinido.
         * @param {object} client - Objeto cliente.
         * @param {object} project - Objeto proyecto (opcional).
         * @returns {string} URL de WhatsApp.
         */
        function generateWhatsAppLink(client, project = null) {
            const status = project ? project.status : null;
            // Si hay proyecto, usa el mensaje de estado, sino usa un saludo genérico
            const messageTemplate = status ? state.settings[status] : 'Hola [NOMBRE_CLIENTE], te escribo desde Acuarela Design Studio.';

            const {
                balance
            } = project ? calculateProjectBalance(project.id) : {
                balance: 0
            };
            const formattedBalance = `$${balance.toFixed(2)}`;

            const message = messageTemplate
                .replace('[NOMBRE_CLIENTE]', client.name)
                .replace('[NOMBRE_PROYECTO]', project ? project.name : 'tu proyecto')
                .replace('[SALDO_PENDIENTE]', formattedBalance);

            // Sanitizar el número de teléfono (solo dígitos)
            const number = client.whatsapp_number.replace(/[^0-9]/g, '');

            const safeNumber = number.length >= 10 ? number : '5215512345678'; // Ejemplo MX
            const encodedMessage = encodeURIComponent(message);
            return `https://wa.me/${safeNumber}?text=${encodedMessage}`;
        }

        /**
         * Crea el HTML para una badge con el conteo.
         * @param {number} count El número a mostrar.
         * @returns {string} HTML de la badge.
         */
        const createBadge = (count) => {
            return `<span class="title-badge bg-gray-200 text-gray-700">${count}</span>`;
        };

        // ====================================================================
        // 3. MANIPULACIÓN DE DATOS (CRUD SIMPLIFICADO)
        // ====================================================================

        /**
         * Añade o actualiza un cliente.
         */
        function saveClient(clientData, navigateToDetail = true) {
            if (!clientData.id) {
                // Nuevo cliente: inicializar campos
                clientData.id = crypto.randomUUID();
                clientData.creationDate = new Date().toISOString(); // NUEVO: Fecha de creación
                clientData.isActive = true; // NUEVO: Activo por defecto
                state.clients.push(clientData);
            } else {
                const index = state.clients.findIndex(c => c.id === clientData.id);
                if (index !== -1) {
                    // Actualizar cliente existente
                    state.clients[index] = {
                        ...state.clients[index],
                        ...clientData
                    };
                }
            }
            saveData();
            if (navigateToDetail) {
                navigate('client_detail', clientData.id);
            }
            return clientData.id;
        }

        /**
         * Añade o actualiza un proyecto.
         */
        function saveProject(projectData) {
            if (!projectData.id) {
                projectData.id = crypto.randomUUID();
                projectData.creationDate = new Date().toISOString();
                projectData.status = projectData.status || PROJECT_STATUSES[0];
                state.projects.push(projectData);
            } else {
                const index = state.projects.findIndex(p => p.id === projectData.id);
                if (index !== -1) {
                    state.projects[index] = {
                        ...state.projects[index],
                        ...projectData,
                        lastUpdated: new Date().toISOString()
                    };
                }
            }
            saveData();
            navigate('project_detail', projectData.clientId, projectData.id);
        }

        /**
         * Registra un nuevo abono.
         */
        function addPayment(projectId, amount) {
            const payment = {
                id: crypto.randomUUID(),
                projectId: projectId,
                amount: parseFloat(amount),
                date: new Date().toISOString(),
            };
            state.payments.push(payment);
            saveData();
            const project = state.projects.find(p => p.id === projectId);
            if (project) {
                navigate('project_detail', project.clientId, projectId);
            }
        }

        // ====================================================================
        // 4. FUNCIONES DE RENDERING Y UI
        // ====================================================================

        const viewContainer = document.getElementById('view-container');

        /** Muestra el modal de forma síncrona. */
        function showModal(title, message, isConfirm = false) {
            return new Promise(resolve => {
                const container = document.getElementById('modal-container');
                document.getElementById('modal-title').innerHTML = title;
                document.getElementById('modal-message').innerHTML = message;

                const cancelBtn = document.getElementById('modal-cancel-btn');
                const actionBtn = document.getElementById('modal-action-btn');

                cancelBtn.classList.toggle('hidden', !isConfirm);

                actionBtn.onclick = () => {
                    container.classList.add('hidden');
                    resolve(true);
                };

                cancelBtn.onclick = () => {
                    container.classList.add('hidden');
                    resolve(false);
                };

                container.classList.remove('hidden');
            });
        }


        /**
         * Muestra una notificación temporal.
         */
        function showNotification(message, type = 'success') {
            let bgColor = type === 'success' ? 'bg-green-500' : 'bg-red-500';
            let notification = document.createElement('div');
            notification.className = `fixed top-16 right-4 p-3 rounded-lg text-white font-semibold shadow-xl ${bgColor} z-50 transition-opacity duration-300`;
            notification.textContent = message;
            document.getElementById('main-content-wrapper').appendChild(notification);

            setTimeout(() => {
                notification.classList.add('opacity-0');
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }


        /**
         * Mapea el estado a colores de Tailwind.
         */
        function getStatusClass(status) {
            const cleanStatus = status.replace(/\s/g, '_');
            return `badge-project-status status-${cleanStatus}`;
        }

        // INICIO CORRECCIÓN DE ESTILOS Y UNIFICACIÓN DE TARJETA
        /**
         * Renderiza una tarjeta de proyecto (unificada para Dashboard y Detalle de Cliente).
         * @param {Object} project - Objeto proyecto con sus cálculos de balance.
         * @param {Object} client - Objeto cliente asociado.
         * @returns {string} HTML de la tarjeta del proyecto.
         */
        function renderProjectCard(project, client) {
            const {
                balance,
                totalPaid
            } = calculateProjectBalance(project.id);
            const total = parseFloat(project.totalPrice).toFixed(2);
            const paid = totalPaid.toFixed(2);
            const statusClass = getStatusClass(project.status);
            const initialPrice = parseFloat(project.totalPrice);
            const percentPaid = initialPrice > 0 ? (totalPaid / initialPrice) * 100 : 100;

            const imageSrc = project.thumbnailBase64 || `https://placehold.co/120x120/E5E7EB/4B5563?text=${project.name.charAt(0).toUpperCase()}`;

            return `
                <a href="#" onclick="event.preventDefault(); navigate('project_detail', '${project.clientId}', '${project.id}')" class="project-card-link" aria-label="Ver detalles del proyecto ${project.name}">
                    <article class="card p-4 transition-all duration-300 hover:shadow-lg">
                        <div class="project-content-detail">
                            <img src="${imageSrc}" alt="Vista previa del proyecto ${project.name}" class="project-image-detail">
                            <div class="flex-1 min-w-0">
                                <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-2 mb-2">
                                    <h3 class="text-lg font-bold text-gray-900 leading-tight">${project.name} (${client.name})</h3>
                                    <span class="${statusClass}">
                                        <i class="fas fa-circle w-3 h-3 text-xs"></i>
                                        ${project.status}
                                    </span>
                                </div>
                                <p class="text-gray-600 mb-3 text-sm">
                                    ${project.description.substring(0, 100)}...
                                </p>
                                <div class="project-details-row">
                                    <span class="flex items-center gap-1 text-gray-500">
                                        <i class="fas fa-calendar-alt w-4 h-4 text-gray-400"></i>
                                        Entrega: <strong>${project.deliveryDate ? new Date(project.deliveryDate).toLocaleDateString('es-ES') : 'N/A'}</strong>
                                    </span>
                                    
                                    <span class="flex items-center gap-1 ${balance > 0.01 ? 'text-red-600' : 'text-green-600'}">
                                        <i class="fas fa-dollar-sign w-4 h-4" aria-hidden="true"></i>
                                        Pago: <strong>$${paid} / $${total}</strong>
                                    </span>
                                    <span class="text-sm ${balance > 0.01 ? 'text-red-600 font-bold' : 'text-green-600 font-bold'}">
                                        ${balance > 0.01 ? `$${balance.toFixed(2)} Pendiente` : `Saldo Pagado`}
                                    </span>
                                </div>
                                <div class="w-full bg-gray-200 rounded-full h-1 mt-2">
                                    <div class="h-1 rounded-full ${balance > 0.01 ? 'bg-red-400' : 'bg-green-500'}" style="width: ${percentPaid.toFixed(0)}%"></div>
                                </div>
                            </div>
                        </div>
                    </article>
                </a>
            `;
        }


        /**
         * Función para renderizar el contenido de las pestañas de proyecto (Ahora usa renderProjectCard).
         * @param {string} clientId - ID del cliente.
         * @param {string} filterType - Tipo de filtro ('all', 'active', 'completed').
         * @param {Array<Object>} [all=null] - Lista de proyectos completa (cache opcional).
         * @param {Array<Object>} [active=null] - Lista de proyectos activos (cache opcional).
         * @param {Array<Object>} [completed=null] - Lista de proyectos completados (cache opcional).
         */
        function renderProjectTabContent(clientId, filterType, all = null, active = null, completed = null) {
            const client = state.clients.find(c => c.id === clientId);

            const projects = all || state.projects.filter(p => p.clientId === clientId).map(p => ({
                ...p,
                ...calculateProjectBalance(p.id)
            }));
            const activeProjects = active || projects.filter(p => p.status !== 'Entregado' && p.status !== 'Cancelado');
            const completedProjects = completed || projects.filter(p => p.status === 'Entregado' || p.status === 'Cancelado');

            let filteredList = [];
            let emptyMessage = '';

            switch (filterType) {
                case 'active':
                    filteredList = activeProjects;
                    emptyMessage = 'No hay proyectos activos en este momento.';
                    break;
                case 'completed':
                    filteredList = completedProjects;
                    emptyMessage = 'No hay proyectos completados o cancelados.';
                    break;
                case 'all':
                default:
                    filteredList = projects;
                    emptyMessage = 'Este cliente no tiene proyectos registrados.';
                    break;
            }

            if (filteredList.length === 0) {
                return `<p class="text-center text-gray-500 py-8">${emptyMessage}</p>`;
            }

            return filteredList.map(project => renderProjectCard(project, client)).join('');
        }

        function switchProjectTab(clientId, filterType) {
            // 1. Actualizar estilos de pestaña
            document.querySelectorAll('.nav-link-project').forEach(tab => {
                tab.classList.remove('active');
                tab.setAttribute('aria-selected', 'false');
            });

            const activeTabId = `tab-${filterType}`;
            const activeTab = document.getElementById(activeTabId);
            if (activeTab) {
                activeTab.classList.add('active');
                activeTab.setAttribute('aria-selected', 'true');
            }

            // 2. Renderizar contenido
            const contentDiv = document.getElementById('tab-content');
            contentDiv.innerHTML = renderProjectTabContent(clientId, filterType);
        }
        // FIN CORRECCIÓN DE ESTILOS Y UNIFICACIÓN DE TARJETA

        // ====================================================================
        // 5. RENDERING DE VISTAS ESPECÍFICAS
        // (REORGANIZADAS PARA EVITAR ReferenceError)
        // ====================================================================

        function renderDashboard() {
            const allProjects = state.projects.map(p => ({
                ...p,
                client: state.clients.find(c => c.id === p.clientId),
                ...calculateProjectBalance(p.id)
            })).filter(p => p.client); // Filtra proyectos sin cliente (solo si hay inconsistencia)

            const activeProjects = allProjects.filter(p => p.status !== 'Entregado' && p.status !== 'Cancelado');
            const pastProjects = allProjects.filter(p => p.status === 'Entregado' || p.status === 'Cancelado');

            // CÁLCULOS FINANCIEROS
            const totalIncome = allProjects.reduce((sum, p) => sum + p.totalPaid, 0);

            // CORRECCIÓN DE SYNTAX ERROR: paréntesis agregado al final
            const totalPendingIncome = activeProjects.reduce((sum, p) => p.balance > 0 ? sum + p.balance : sum, 0);

            const pendingPaymentProjects = activeProjects.filter(p => p.balance > 0);
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const tomorrow = new Date(today);
            tomorrow.setDate(tomorrow.getDate() + 1);
            const upcomingDeadlines = activeProjects
                .filter(p => p.deliveryDate && new Date(p.deliveryDate) > today)
                .sort((a, b) => new Date(a.deliveryDate) - new Date(b.deliveryDate))
                .slice(0, 5); // Mostrar los 5 más cercanos

            const imminentDeadlines = upcomingDeadlines.filter(p => new Date(p.deliveryDate) <= tomorrow);

            // Determinar si hay algún proyecto para mostrar los estados vacíos
            const hasProjects = allProjects.length > 0;

            // RENDERIZADO
            viewContainer.innerHTML = `
                <h2 class="text-3xl font-bold text-gray-800 mb-6">Dashboard</h2>
                
                ${hasProjects ? `
                    <div class="card p-4 mb-8">
                        <div class="grid grid-cols-3 md:grid-cols-3 gap-4">
                            <div class="watercolor-card wc-green">
                                <p class="wc-title">Ingreso Total</p>
                                <p class="wc-value">$${totalIncome.toFixed(2)}</p>
                            </div>

                            <div class="watercolor-card wc-orange">
                                <p class="wc-title">Pagos Pendientes</p>
                                <p class="wc-value">${pendingPaymentProjects.length}</p>
                                <p class="text-sm mt-1 font-semibold text-gray-600">$${totalPendingIncome.toFixed(2)}</p>
                            </div>

                            <div class="watercolor-card wc-blue">
                                <p class="wc-title">Próximas Entregas</p>
                                <p class="wc-value">${imminentDeadlines.length}</p>
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                        <div class="card p-5">
                            <h3 class="text-xl font-semibold mb-4 text-red-600 flex items-center">
                                Trabajos con Pagos Pendientes
                                ${createBadge(pendingPaymentProjects.length)}
                            </h3>
                            ${pendingPaymentProjects.length > 0 ?
                        pendingPaymentProjects.map(p => `
                                    <div class="flex justify-between items-center py-2 border-b last:border-b-0">
                                        <p class="text-sm text-gray-800 font-medium cursor-pointer hover:text-[#0ea5e9]" onclick="navigate('project_detail', '${p.clientId}', '${p.id}')">${p.name} (${p.client.name})</p>
                                        <span class="text-red-500 font-semibold">$${p.balance.toFixed(2)}</span>
                                    </div>
                                `).join('') :
                        '<p class="text-gray-500 italic">¡Todo al día! No hay pagos pendientes.</p>'
                    }
                        </div>

                        <div class="card p-5">
                            <h3 class="text-xl font-semibold mb-4 text-blue-600 flex items-center">
                                Próximas Fechas de Entrega
                                ${createBadge(upcomingDeadlines.length)}
                            </h3>
                            ${upcomingDeadlines.length > 0 ?
                        upcomingDeadlines.map(p => `
                                    <div class="flex justify-between items-center py-2 border-b last:border-b-0">
                                        <p class="text-sm text-gray-800 font-medium cursor-pointer hover:text-[#0ea5e9]" onclick="navigate('project_detail', '${p.clientId}', '${p.id}')">${p.name} (${p.client.name})</p>
                                        <span class="text-blue-500 font-semibold">${new Date(p.deliveryDate).toLocaleDateString('es-ES')}</span>
                                    </div>
                                `).join('') :
                        '<p class="text-gray-500 italic">No hay entregas urgentes a la vista.</p>'
                    }
                        </div>
                    </div>

                    <div class="card p-5 mb-6">
                        <h3 class="text-2xl font-semibold mb-4 text-gray-700 flex items-center">
                            Trabajos Activos
                            ${createBadge(activeProjects.length)}
                        </h3>
                        <div class="space-y-4">
                            ${activeProjects.map(p => renderProjectCard(p, p.client)).join('')}
                            ${activeProjects.length === 0 ? '<p class="text-gray-500 p-4 text-center">No hay proyectos activos.</p>' : ''}
                        </div>
                    </div>

                    <div class="card p-5">
                        <h3 class="text-2xl font-semibold mb-4 text-gray-700 flex items-center">
                            Trabajos Anteriores
                            ${createBadge(pastProjects.length)}
                        </h3>
                        <div class="space-y-4">
                            ${pastProjects.map(p => renderProjectCard(p, p.client)).join('')}
                            ${pastProjects.length === 0 ? '<p class="text-gray-500 p-4 text-center">No hay proyectos finalizados o cancelados.</p>' : ''}
                        </div>
                    </div>
                ` : `
                    <div class="card p-10 text-center bg-blue-50">
                        <svg class="mx-auto h-12 w-12 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 13h6m-3-3v6m5 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                        <h3 class="mt-2 text-xl font-bold text-gray-900">¡Bienvenida a Acuarela CRM!</h3>
                        <p class="mt-1 text-gray-600">Tu panel está listo. Comienza creando tu primer cliente y proyecto para ver el resumen de tus finanzas y trabajos.</p>
                        <div class="mt-6">
                            <button class="btn-primary flex items-center space-x-2 mx-auto" onclick="checkForClientsBeforeProject()">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
                                <span>Añadir Primer Cliente/Proyecto</span>
                            </button>
                        </div>
                    </div>
                `}
            `;
        }

        // ====================== MODIFIED FUNCTION START ======================
        function renderClientList() {
            const allProjects = state.projects.map(p => ({
                ...p,
                ...calculateProjectBalance(p.id)
            }));

            const clientsWithSummary = state.clients.map(client => {
                const clientProjects = allProjects.filter(p => p.clientId === client.id);
                const activeCount = clientProjects.filter(p => p.status !== 'Entregado' && p.status !== 'Cancelado').length;
                const totalBalance = clientProjects.reduce((sum, p) => sum + p.balance, 0);

                return {
                    ...client,
                    activeCount,
                    totalBalance
                };
            });

            const term = state.searchTerm.toLowerCase();
            const filteredClients = clientsWithSummary.filter(c => {
                if (!term) return true;
                return c.name.toLowerCase().includes(term) || (c.whatsapp_number && c.whatsapp_number.includes(term));
            });

            if (state.clients.length === 0) {
                viewContainer.innerHTML = `
                    <h2 class="text-3xl font-bold text-gray-800 mb-6">Clientes</h2>
                    <div class="card p-10 text-center bg-gray-50">
                        <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20v-2a3 3 0 015.356-1.857M7 20h4m-4 0v-2c0-.656-.126-1.283-.356-1.857M7 20H4a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                        <h3 class="mt-2 text-xl font-bold text-gray-900">Lista de Clientes Vacía</h3>
                        <p class="mt-1 text-gray-600">Aún no has registrado ningún cliente. Comienza agregando uno nuevo.</p>
                        <div class="mt-6">
                             <button onclick="navigate('create_client')" class="btn-primary">
                                <i class="fas fa-plus mr-2"></i>
                                Crear Primer Cliente
                            </button>
                        </div>
                    </div>
                `;
                return;
            }

            viewContainer.innerHTML = `
                <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                    <h2 class="text-3xl font-bold text-gray-800 flex items-center">
                        Clientes
                        ${createBadge(state.clients.length)}
                    </h2>
                     <button onclick="navigate('create_client')" class="btn-primary w-full md:w-auto">
                        <i class="fas fa-plus mr-2"></i>
                        <span>Crear Cliente</span>
                    </button>
                </div>
                
                <div class="mb-6">
                     <div class="relative">
                         <i class="fas fa-search absolute left-4 top-1/2 -translate-y-1/2 text-gray-400"></i>
                         <input type="text" id="search-input" value="${state.searchTerm}"
                                class="w-full rounded-lg bg-white border border-gray-200 focus:border-[#0ea5e9] focus:ring-[#0ea5e9] pl-12 pr-4 py-3 shadow-sm"
                                placeholder="Buscar por nombre o WhatsApp"
                                oninput="handleSearch(event)">
                     </div>
                </div>

                <div class="overflow-x-auto card border border-gray-200/80">
                    <table class="w-full text-left">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="p-4 font-semibold text-gray-600">Contacto</th>
                                <th class="p-4 font-semibold text-gray-600">Métricas Operativas</th>
                                <th class="p-4 font-semibold text-gray-600">Acciones</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-100">
                            ${filteredClients.map(client => {
                // Logic for contact info display as requested
                const contactInfo = client.whatsapp_number || client.email || '';
                return `
                                    <tr class="hover:bg-gray-50 transition cursor-pointer" onclick="navigate('client_detail', '${client.id}')">
                                        <td class="p-4 align-top">
                                            <div class="flex items-center gap-4">
                                                ${getClientAvatarHtml(client, 'w-10 h-10')}
                                                <div>
                                                    <p class="font-semibold text-gray-900">${client.name}</p>
                                                    <p class="text-sm text-gray-500">${contactInfo}</p>
                                                </div>
                                            </div>
                                        </td>
                                        <td class="p-4 align-top">
                                            <p class="font-medium text-gray-800">${client.activeCount} Trabajo${client.activeCount !== 1 ? 's' : ''} Activo${client.activeCount !== 1 ? 's' : ''}</p>
                                            <p class="text-sm ${client.totalBalance > 0.01 ? 'text-red-600' : 'text-gray-500'}">
                                                Saldo Pendiente: $${client.totalBalance.toFixed(2)}
                                            </p>
                                        </td>
                                        <td class="p-4 align-top">
                                            <div class="flex items-center gap-2">
                                                <a href="${generateWhatsAppLink(client)}" target="_blank" onclick="event.stopPropagation();"
                                                   class="flex items-center gap-1.5 rounded-full px-3 py-1.5 text-sm font-medium bg-green-100 text-green-700 hover:bg-green-200 transition">
                                                    <i class="fab fa-whatsapp text-base"></i>
                                                    <span>WhatsApp</span>
                                                </a>
                                                <button onclick="event.stopPropagation(); navigate('create_project', '${client.id}')"
                                                        class="flex items-center gap-1.5 rounded-full px-3 py-1.5 text-sm font-medium bg-gray-200/60 hover:bg-gray-200 transition">
                                                    <i class="fas fa-plus-circle text-base"></i>
                                                    <span>Proyecto</span>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                `;
            }).join('')}
                        </tbody>
                    </table>
                    ${filteredClients.length === 0 && state.clients.length > 0 ? '<p class="text-gray-500 p-4 text-center">No se encontraron clientes con el criterio de búsqueda.</p>' : ''}
                </div>
            `;
        }
        // ====================== MODIFIED FUNCTION END ========================

        function renderClientDetail(clientId) {
            const client = state.clients.find(c => c.id === clientId);
            if (!client) {
                return viewContainer.innerHTML = '<p class="p-8 text-center text-red-500">Cliente no encontrado.</p>';
            }

            const allProjects = state.projects
                .filter(p => p.clientId === clientId)
                .map(p => ({
                    ...p,
                    ...calculateProjectBalance(p.id)
                }));

            // CÁLCULOS
            const activeProjects = allProjects.filter(p => p.status !== 'Entregado' && p.status !== 'Cancelado');
            const completedProjects = allProjects.filter(p => p.status === 'Entregado' || p.status === 'Cancelado');
            const totalBalance = allProjects.reduce((sum, p) => sum + p.balance, 0);
            const totalFacturado = allProjects.reduce((sum, p) => sum + p.totalPaid, 0);
            const totalProyectos = allProjects.length;
            const creationDate = client.creationDate ? new Date(client.creationDate).toLocaleDateString('es-ES', {
                day: 'numeric',
                month: 'short',
                year: 'numeric'
            }) : 'N/A';
            const clientActiveStatus = client.isActive ? 'Activo' : 'Inactivo';
            const clientBadgeClass = client.isActive ? 'badge-success-client' : 'badge-inactive-client';
            const clientIcon = client.isActive ? 'fas fa-check-circle' : 'fas fa-times-circle';


            // Renderiza la vista principal con la nueva estructura
            viewContainer.innerHTML = `
                <div class="max-w-7xl mx-auto fade-in">
                    
                    <nav class="mb-6" aria-label="Breadcrumb">
                        <button class="text-gray-600 hover:text-gray-900 flex items-center gap-2 group transition-colors" onclick="navigate('client_list')" aria-label="Volver a lista de clientes">
                            <i class="fas fa-arrow-left w-5 h-5 group-hover:-translate-x-1 transition-transform"></i>
                            <span class="font-medium">Volver a Clientes</span>
                        </button>
                    </nav>

                    <div class="card p-6 md:p-8 mb-6">
                        <div class="flex flex-col md:flex-row gap-6 items-start md:items-center justify-between">
                            
                            <div class="flex flex-col md:flex-row gap-6 items-start md:items-center flex-1">
                                <div class="avatar-container" role="img" aria-label="Avatar de ${client.name}">
                                    <div class="avatar-inner">
                                        ${getClientAvatarHtml(client, 'w-full h-full')}
                                    </div>
                                </div>
                                
                                <div class="flex-1">
                                    <div class="flex items-center gap-3 mb-2">
                                        <h1 class="text-3xl md:text-4xl font-bold text-gray-900">${client.name}</h1>
                                        <span class="${clientBadgeClass}" role="status" aria-label="Cliente ${clientActiveStatus}">
                                            <i class="${clientIcon} w-4 h-4"></i>
                                            ${clientActiveStatus}
                                        </span>
                                    </div>
                                    
                                    <div class="space-y-2">
                                        <div class="flex items-center gap-3 text-gray-700">
                                            <i class="fab fa-whatsapp w-5 h-5 text-gray-400" aria-hidden="true"></i>
                                            <span class="font-medium">${client.whatsapp_number}</span>
                                        </div>
                                        
                                        ${client.email ? `
                                            <div class="flex items-center gap-3 text-gray-700">
                                                <i class="fas fa-envelope w-5 h-5 text-gray-400" aria-hidden="true"></i>
                                                <a href="mailto:${client.email}" class="hover:text-purple-600 font-medium transition-colors">${client.email}</a>
                                            </div>
                                        ` : ''}
                                        
                                        <div class="flex items-center gap-3 text-gray-600">
                                            <i class="fas fa-calendar-alt w-5 h-5 text-gray-400" aria-hidden="true"></i>
                                            <span>Cliente desde: <strong>${creationDate}</strong></span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="flex flex-col gap-3 w-full md:w-auto">
                                
                                <button onclick="openEditClientModal('${client.id}')" class="btn-secondary-custom w-full" aria-label="Editar información del cliente">
                                    <i class="fas fa-edit w-5 h-5"></i>
                                    <span>Editar Cliente</span>
                                </button>
                                
                                <a href="${generateWhatsAppLink(client)}" target="_blank" class="btn btn-whatsapp w-full" aria-label="Iniciar conversación en WhatsApp">
                                    <i class="fab fa-whatsapp w-5 h-5" aria-hidden="true"></i>
                                    Iniciar Chat
                                </a>
                                
                                <button onclick="deleteClient('${client.id}')" class="btn-secondary-custom w-full text-red-600 border-red-300 hover:bg-red-50" aria-label="Eliminar cliente">
                                    <i class="fas fa-trash-alt w-5 h-5"></i>
                                    Eliminar Cliente
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                        
                        <div class="metric-card">
                            <div class="flex items-center justify-between mb-3">
                                <div class="icon-bg bg-blue-100">
                                    <i class="fas fa-folder-open w-6 h-6 text-blue-600"></i>
                                </div>
                            </div>
                            <p class="text-sm font-medium text-gray-600 mb-1">Proyectos Activos</p>
                            <p class="text-3xl font-bold text-gray-900">${activeProjects.length}</p>
                        </div>
                        
                        <div class="metric-card">
                            <div class="flex items-center justify-between mb-3">
                                <div class="icon-bg bg-yellow-100">
                                    <i class="fas fa-money-bill-wave w-6 h-6 text-yellow-600"></i>
                                </div>
                            </div>
                            <p class="text-sm font-medium text-gray-600 mb-1">Saldo Pendiente</p>
                            <p class="text-3xl font-bold ${totalBalance > 0.01 ? 'text-red-600' : 'text-green-600'}">$${totalBalance.toFixed(2)}</p>
                        </div>
                        
                        <div class="metric-card">
                            <div class="flex items-center justify-between mb-3">
                                <div class="icon-bg bg-green-100">
                                    <i class="fas fa-check-circle w-6 h-6 text-green-600"></i>
                                </div>
                            </div>
                            <p class="text-sm font-medium text-gray-600 mb-1">Total Facturado</p>
                            <p class="text-3xl font-bold text-green-600">$${totalFacturado.toFixed(2)}</p>
                        </div>
                    </div>

                    <div class="card p-6 md:p-8">
                        <div class="flex items-center justify-between mb-6">
                            <h2 class="text-2xl font-bold text-gray-900 flex items-center gap-3">
                                Proyectos
                                <span class="badge badge-info title-badge bg-blue-200 text-blue-800" role="status">${totalProyectos}</span>
                            </h2>
                            
                            <button onclick="navigate('create_project', '${client.id}')" class="btn btn-primary p-2 md:p-3" aria-label="Crear nuevo proyecto para este cliente">
                                <i class="fas fa-plus w-5 h-5"></i>
                                <span class="hidden md:inline">Nuevo Proyecto</span>
                            </button>
                        </div>
                        
                        <div role="tablist" aria-label="Filtrar proyectos" class="flex flex-wrap gap-4 mb-6 border-b border-gray-200">
                            <button id="tab-all" aria-selected="true" aria-controls="proyectos-todos" class="nav-link-project active" onclick="switchProjectTab('${client.id}', 'all')">
                                Todos (${totalProyectos})
                            </button>
                            <button id="tab-active" aria-selected="false" aria-controls="proyectos-activos" class="nav-link-project" onclick="switchProjectTab('${client.id}', 'active')">
                                Activos (${activeProjects.length})
                            </button>
                            <button id="tab-completed" aria-selected="false" aria-controls="proyectos-completados" class="nav-link-project" onclick="switchProjectTab('${client.id}', 'completed')">
                                Completados (${completedProjects.length})
                            </button>
                        </div>
                        
                        <div id="tab-content" class="space-y-4">
                            ${renderProjectTabContent(client.id, 'all', allProjects, activeProjects, completedProjects)}
                        </div>

                    </div>
                </div>
            `;
        }

        function renderProjectDetail(projectId) {
            const project = state.projects.find(p => p.id === projectId);
            if (!project) {
                return viewContainer.innerHTML = '<p class="p-8 text-center text-red-500">Proyecto no encontrado.</p>';
            }
            const client = state.clients.find(c => c.id === project.clientId);
            if (!client) {
                return viewContainer.innerHTML = '<p class="p-8 text-center text-red-500">Cliente del proyecto no encontrado.</p>';
            }

            const {
                balance,
                totalPaid
            } = calculateProjectBalance(projectId);
            const payments = state.payments.filter(p => p.projectId === projectId).sort((a, b) => new Date(b.date) - new Date(a.date));

            viewContainer.innerHTML = `
                <button class="text-[#0ea5e9] mb-4 flex items-center hover:underline" onclick="navigate('client_detail', '${client.id}')">
                    &larr; Volver al Cliente: ${client.name}
                </button>
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

                    <div class="lg:col-span-2 space-y-6">

                        <div class="card p-6">
                            <div class="flex justify-between items-start mb-4 border-b pb-4">
                                <h2 class="text-3xl font-bold text-gray-800">${project.name}</h2>
                                <span class="status-badge text-lg ${getStatusClass(project.status)}">${project.status}</span>
                            </div>

<div class="mb-4">
    <h3 class="text-xl font-semibold mb-2 text-gray-700">Cliente</h3>
    <div class="flex justify-between items-center bg-gray-50 p-3 rounded-lg">
        <p class="font-medium">${client.name}</p>
        <a href="${generateWhatsAppLink(client, project)}" target="_blank"
           class="text-sm bg-green-500 text-white px-3 py-1 rounded-full hover:bg-green-600 transition flex items-center space-x-1">
           <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 1280 720">
                <path d="M6255 6844 c-540 -35 -1107 -229 -1555 -532 -473 -320 -848 -752 -1091 -1256 -133 -276 -216 -536 -273 -856 -43 -240 -52 -602 -22 -880 40 -374 177 -822 362 -1188 l53 -103 -123 -367 c-68 -202 -191 -570 -274 -818 -84 -249 -152 -459 -152 -469 0 -9 13 -22 29 -28 26 -10 29 -14 24 -45 -6 -32 -5 -34 18 -27 41 13 936 298 1314 420 198 63 368 115 378 115 9 0 52 -17 95 -39 366 -184 756 -294 1171 -332 164 -14 498 -7 659 16 954 132 1766 659 2266 1468 163 264 318 632 401 952 79 307 117 688 96 982 -54 781 -356 1473 -881 2017 -509 527 -1157 853 -1895 952 -108 14 -482 26 -600 18z m391 -684 c357 -29 650 -108 959 -259 419 -206 770 -514 1030 -906 200 -301 323 -625 371 -979 23 -168 23 -508 0 -680 -163 -1209 -1161 -2141 -2372 -2217 -427 -26 -824 44 -1212 214 -107 47 -284 143 -339 183 -17 13 -39 24 -49 24 -9 0 -222 -65 -472 -145 -250 -80 -456 -145 -457 -143 -2 2 62 197 141 433 79 237 144 442 144 458 0 16 -18 53 -44 90 -418 599 -554 1426 -351 2127 45 152 82 245 155 390 200 391 505 732 880 982 473 316 1064 472 1616 428z M5323 5236 c-23 -7 -56 -23 -75 -34 -51 -32 -199 -190 -245 -262 -147 -229 -180 -534 -92 -832 67 -225 149 -397 299 -629 190 -292 313 -450 510 -653 296 -305 545 -476 927 -635 282 -118 490 -185 607 -197 81 -8 258 20 362 58 144 52 309 168 373 262 64 96 130 313 138 457 l6 95 -31 36 c-22 24 -112 78 -294 176 -432 232 -487 254 -555 218 -17 -8 -81 -73 -141 -143 -178 -207 -215 -243 -245 -243 -38 0 -287 127 -403 205 -135 92 -223 166 -334 281 -132 137 -275 333 -355 486 l-18 36 72 79 c95 101 134 162 172 268 39 108 37 141 -20 290 -51 133 -92 243 -163 434 -58 157 -101 221 -161 240 -57 17 -287 22 -334 7z"/>
           </svg>
           WhatsApp
        </a>
    </div>
</div>

                            <p class="text-sm text-gray-500 mb-4">Creado: ${new Date(project.creationDate).toLocaleDateString('es-ES')} ${project.deliveryDate ? `| Entrega Estimada: <span class="font-medium text-blue-600">${new Date(project.deliveryDate).toLocaleDateString('es-ES')}</span>` : ''}</p>

                            <h3 class="text-xl font-semibold mb-2 text-gray-700">Acuerdo y Notas</h3>
                            <p class="text-gray-600 whitespace-pre-wrap mb-4">${project.description}</p>
                            <button class="text-sm text-blue-600 hover:text-blue-800" onclick="openEditProjectModal('${projectId}')">Editar Descripción/Detalles</button>
                        </div>

                        <div class="card p-6">
                            <h3 class="text-xl font-semibold mb-4 text-gray-700">Gestión de Pagos</h3>

                            <div class="flex justify-between items-center mb-4 p-3 bg-gray-50 rounded-lg">
                                <div>
                                    <p class="text-sm text-gray-500">Precio Total Acordado</p>
                                    <p class="text-2xl font-bold text-gray-900">$${parseFloat(project.totalPrice).toFixed(2)}</p>
                                </div>
                                <div>
                                    <p class="text-sm text-gray-500">Total Abonado</p>
                                    <p class="text-2xl font-bold text-green-600">$${totalPaid.toFixed(2)}</p>
                                </div>
                                <div>
                                    <p class="text-sm text-gray-500">Saldo Pendiente</p>
                                    <p class="text-2xl font-bold ${balance > 0.01 ? 'text-red-600' : 'text-gray-900'}">$${balance.toFixed(2)}</p>
                                </div>
                            </div>

                            <div class="flex space-x-3 mb-4">
                                <input type="number" id="payment-amount" placeholder="Monto del Abono ($)" class="flex-grow p-2 border border-gray-300 rounded-lg focus:ring-[#0ea5e9] focus:border-[#0ea5e9]">
                                <button class="btn-primary" onclick="handleNewPayment('${projectId}')">Registrar Abono</button>
                            </div>

                            <h4 class="font-medium text-gray-700 mt-6 mb-2">Historial de Pagos</h4>
                            <div class="divide-y divide-gray-100">
                                ${payments.length > 0 ?
                    payments.map(p => `
                                        <div class="flex justify-between py-2 text-sm">
                                            <span>Pago de <span class="font-bold">$${p.amount.toFixed(2)}</span></span>
                                            <span class="text-gray-500">${new Date(p.date).toLocaleDateString('es-ES')}</span>
                                        </div>
                                    `).join('') :
                    '<p class="text-gray-500 italic text-sm">No hay pagos registrados aún.</p>'
                }
                            </div>
                        </div>
                    </div>

                    <div class="lg:col-span-1 space-y-6">
                        <div class="card p-5">
                            <h3 class="text-xl font-semibold mb-3 text-gray-700">Actualizar Estado</h3>
                            <select id="project-status" onchange="updateProjectStatus('${projectId}', this.value)" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-[#0ea5e9] focus:border-[#0ea5e9]">
                                ${PROJECT_STATUSES.map(s => `
                                    <option value="${s}" ${project.status === s ? 'selected' : ''}>${s}</option>
                                `).join('')}
                            </select>
                        </div>

                        <div class="card p-5">
                            <h3 class="text-xl font-semibold mb-3 text-gray-700">Imagen de Avance</h3>
                            ${project.thumbnailBase64 ?
                    `<img src="${project.thumbnailBase64}" alt="Miniatura del Proyecto" class="w-full h-auto rounded-lg mb-4 object-cover">` :
                    `<div class="w-full h-32 bg-gray-100 flex items-center justify-center rounded-lg mb-4 text-gray-500 text-sm">Sin miniatura de avance</div>`
                }
                            <input type="file" id="thumbnail-upload" accept="image/*" onchange="handleThumbnailUpload('${projectId}')" class="text-sm w-full">
                            ${project.thumbnailBase64 ? `<button class="text-xs text-red-500 mt-2 hover:text-red-700" onclick="removeThumbnail('${projectId}')">Eliminar Miniatura</button>` : ''}
                        </div>

                        <div class="card p-5">
                            <h3 class="text-xl font-semibold mb-3 text-gray-700">Acciones</h3>
                             <button class="w-full text-red-600 bg-red-100 p-2 rounded-lg hover:bg-red-200 transition font-medium" onclick="deleteProject('${projectId}')">
                                Eliminar Proyecto
                            </button>
                        </div>
                    </div>
                </div>

            `;
        }

        function renderCreateClientForm() {
            viewContainer.innerHTML = `
                <div class="mb-6">
                    <h2 class="text-3xl font-bold text-gray-800">Paso 1: Crear Nuevo Cliente</h2>
                    <p class="text-gray-500">Completa los datos del cliente para empezar el proyecto.</p>
                </div>
                <div class="card p-6 max-w-xl mx-auto">
                    <form id="client-form" onsubmit="event.preventDefault(); handleClientCreation(true);">
                        <div class="mb-4">
                            <label for="client-name" class="block text-sm font-medium text-gray-700">Nombre del Cliente (Obligatorio)</label>
                            <input type="text" id="client-name" required class="mt-1 block w-full p-2 border border-gray-300 rounded-md focus:ring-[#0ea5e9] focus:border-[#0ea5e9]">
                        </div>
                        <div class="mb-4">
                            <label for="client-whatsapp" class="block text-sm font-medium text-gray-700">Número de WhatsApp (Obligatorio)</label>
                            <input type="text" id="client-whatsapp" required placeholder="Ej: +52 55 1234 5678" class="mt-1 block w-full p-2 border border-gray-300 rounded-md focus:ring-[#0ea5e9] focus:border-[#0ea5e9]">
                        </div>
                        <div class="mb-4">
                            <label for="client-email" class="block text-sm font-medium text-gray-700">Correo Electrónico (Opcional)</label>
                            <input type="email" id="client-email" class="mt-1 block w-full p-2 border border-gray-300 rounded-md focus:ring-[#0ea5e9] focus:border-[#0ea5e9]">
                        </div>
                        <div class="mb-6">
                            <label for="client-photo" class="block text-sm font-medium text-gray-700">Fotografía del Cliente (Opcional, 800x800)</label>
                            <input type="file" id="client-photo" accept="image/*" class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                        </div>
                        <button type="submit" class="btn-primary w-full">Crear Cliente y Continuar al Proyecto &rarr;</button>
                    </form>
                </div>
            `;
        }

        function renderCreateClientOnlyForm() {
            viewContainer.innerHTML = `
                <button class="text-[#0ea5e9] mb-4 flex items-center hover:underline" onclick="navigate('client_list')">
                    &larr; Volver a Clientes
                </button>
                <div class="mb-6">
                    <h2 class="text-3xl font-bold text-gray-800">Crear Nuevo Cliente (Solo)</h2>
                    <p class="text-gray-500">Registra un cliente sin iniciar un proyecto de inmediato.</p>
                </div>
                <div class="card p-6 max-w-xl mx-auto">
                    <form id="client-only-form" onsubmit="event.preventDefault(); handleClientCreation(false);">
                        <div class="mb-4">
                            <label for="client-name-only" class="block text-sm font-medium text-gray-700">Nombre del Cliente (Obligatorio)</label>
                            <input type="text" id="client-name-only" required class="mt-1 block w-full p-2 border border-gray-300 rounded-md focus:ring-[#0ea5e9] focus:border-[#0ea5e9]">
                        </div>
                        <div class="mb-4">
                            <label for="client-whatsapp-only" class="block text-sm font-medium text-gray-700">Número de WhatsApp (Obligatorio)</label>
                            <input type="text" id="client-whatsapp-only" required placeholder="Ej: +52 55 1234 5678" class="mt-1 block w-full p-2 border border-gray-300 rounded-md focus:ring-[#0ea5e9] focus:border-[#0ea5e9]">
                        </div>
                        <div class="mb-4">
                            <label for="client-email-only" class="block text-sm font-medium text-gray-700">Correo Electrónico (Opcional)</label>
                            <input type="email" id="client-email-only" class="mt-1 block w-full p-2 border border-gray-300 rounded-md focus:ring-[#0ea5e9] focus:border-[#0ea5e9]">
                        </div>
                        <div class="mb-6">
                            <label for="client-photo-only" class="block text-sm font-medium text-gray-700">Fotografía del Cliente (Opcional, 800x800)</label>
                            <input type="file" id="client-photo-only" accept="image/*" class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                        </div>
                        <button type="submit" class="btn-primary w-full">Crear Cliente</button>
                    </form>
                </div>
            `;
        }

        function renderCreateProjectForm(clientId) {
            const client = state.clients.find(c => c.id === clientId);

            // Si no hay clientes en la lista global, forzamos al usuario a crear uno.
            if (state.clients.length === 0) {
                return navigate('create_client');
            }

            // Lista de clientes para la selección (si viene de una vista que no es de cliente)
            const clientOptions = state.clients.map(c =>
                `<option value="${c.id}" ${c.id === clientId ? 'selected' : ''}>${c.name}</option>`
            ).join('');

            viewContainer.innerHTML = `
                <div class="mb-6">
                    <h2 class="text-3xl font-bold text-gray-800">${clientId ? 'Paso 2: Crear Proyecto' : 'Crear Nuevo Proyecto'}</h2>
                    <p class="text-gray-500">Define los detalles del nuevo trabajo.</p>
                </div>
                <div class="card p-6 max-w-xl mx-auto">
                    <form id="project-form" onsubmit="event.preventDefault(); handleProjectCreation();">

                        <div class="mb-4">
                            <label for="project-client-id" class="block text-sm font-medium text-gray-700">Asignar Cliente</label>
                            <select id="project-client-id" required class="mt-1 block w-full p-2 border border-gray-300 rounded-md focus:ring-[#0ea5e9] focus:border-[#0ea5e9]">
                                <option value="" disabled ${!clientId ? 'selected' : ''}>Selecciona un Cliente</option>
                                ${clientOptions}
                            </select>
                            <p class="text-xs text-gray-500 mt-1">¿Cliente nuevo? Haz click en Clientes y usa el botón "+ Crear Cliente (Solo)".</p>
                        </div>

                        <div class="mb-4">
                            <label for="project-name" class="block text-sm font-medium text-gray-700">Nombre del Proyecto (Obligatorio)</label>
                            <input type="text" id="project-name" required class="mt-1 block w-full p-2 border border-gray-300 rounded-md focus:ring-[#0ea5e9] focus:border-[#0ea5e9]">
                        </div>

                        <div class="mb-4">
                            <label for="project-price" class="block text-sm font-medium text-gray-700">Precio Total (Obligatorio)</label>
                            <input type="number" step="0.01" min="0" id="project-price" required class="mt-1 block w-full p-2 border border-gray-300 rounded-md focus:ring-[#0ea5e9] focus:border-[#0ea5e9]">
                        </div>

                        <div class="mb-4">
                            <label for="project-description" class="block text-sm font-medium text-gray-700">Descripción del Acuerdo (Obligatorio)</label>
                            <textarea id="project-description" rows="5" required class="mt-1 block w-full p-2 border border-gray-300 rounded-md focus:ring-[#0ea5e9] focus:border-[#0ea5e9]"></textarea>
                        </div>

                        <div class="mb-6">
                            <label for="project-delivery-date" class="block text-sm font-medium text-gray-700">Fecha de Entrega (Opcional)</label>
                            <input type="date" id="project-delivery-date" class="mt-1 block w-full p-2 border border-gray-300 rounded-md focus:ring-[#0ea5e9] focus:border-[#0ea5e9]">
                        </div>

                        <input type="hidden" id="project-status" value="${PROJECT_STATUSES[0]}">

                        <button type="submit" class="btn-primary w-full">Crear Proyecto</button>
                    </form>
                </div>
            `;
        }

        function renderSettings() {
            viewContainer.innerHTML = `
                <h2 class="text-3xl font-bold text-gray-800 mb-6">Ajustes: Mensajes de WhatsApp</h2>
                <p class="text-gray-600 mb-6">Edita las plantillas de mensajes. Usa <code class="bg-gray-200 p-1 rounded">[NOMBRE_CLIENTE]</code>, <code class="bg-gray-200 p-1 rounded">[NOMBRE_PROYECTO]</code> y <code class="bg-gray-200 p-1 rounded">[SALDO_PENDIENTE]</code> para reemplazarlos automáticamente.</p>

                <div class="card p-6 space-y-6">
                    ${PROJECT_STATUSES.map(status => `
                        <div class="border-b pb-4 last:border-b-0">
                            <label for="msg-${status.replace(/\s/g, '_')}" class="block text-lg font-semibold text-gray-700 mb-2">${status}</label>
                            <textarea id="msg-${status.replace(/\s/g, '_')}" rows="3"
                                      class="mt-1 block w-full p-2 border border-gray-300 rounded-md focus:ring-[#0ea5e9] focus:border-[#0ea5e9]"
                                      onblur="saveSetting('${status}', this.value)"
                            >${state.settings[status]}</textarea>
                        </div>
                    `).join('')}
                    <p class="text-sm text-green-600 font-medium">Los cambios se guardan automáticamente al salir del campo de texto.</p>
                </div>
            `;
        }


        // ====================================================================
        // 6. MANEJADORES DE EVENTOS
        // ====================================================================

        async function handleClientCreation(continueToProject) {
            const name = document.getElementById(continueToProject ? 'client-name' : 'client-name-only').value.trim();
            const whatsapp = document.getElementById(continueToProject ? 'client-whatsapp' : 'client-whatsapp-only').value.trim();
            const email = document.getElementById(continueToProject ? 'client-email' : 'client-email-only').value.trim();
            const photoInput = document.getElementById(continueToProject ? 'client-photo' : 'client-photo-only');

            if (!name || !whatsapp) {
                showModal('Error de Formulario', 'Por favor, completa los campos obligatorios (Nombre y WhatsApp).');
                return;
            }

            let photoBase64 = null;
            if (photoInput && photoInput.files.length > 0) {
                photoBase64 = await resizeImageAndConvertToBase64(photoInput.files[0]);
                if (!photoBase64) {
                    showModal('Error de Imagen', 'No se pudo procesar la imagen. Intenta con otro archivo.');
                    return;
                }
            }

            const clientData = {
                name,
                whatsapp_number: whatsapp,
                email,
                photoBase64
            };

            const clientId = saveClient(clientData, false);

            if (continueToProject) {
                showNotification(`Cliente "${name}" creado. Continúa con el proyecto.`, 'success');
                navigate('create_project', clientId);
            } else {
                showNotification(`Cliente "${name}" creado exitosamente.`, 'success');
                navigate('client_list');
            }
        }

        function handleProjectCreation() {
            const clientId = document.getElementById('project-client-id').value;
            const name = document.getElementById('project-name').value.trim();
            const price = document.getElementById('project-price').value;
            const description = document.getElementById('project-description').value.trim();
            const deliveryDate = document.getElementById('project-delivery-date').value;
            const status = document.getElementById('project-status').value;

            if (!clientId || !name || !price || !description) {
                showModal('Error de Formulario', 'Por favor, completa todos los campos obligatorios.');
                return;
            }

            const projectData = {
                clientId,
                name,
                totalPrice: parseFloat(price).toFixed(2),
                description,
                status,
                deliveryDate: deliveryDate || null,
            };

            saveProject(projectData);
            showNotification(`Proyecto "${name}" creado.`, 'success');
        }

        function handleNewPayment(projectId) {
            const amountInput = document.getElementById('payment-amount');
            const amount = parseFloat(amountInput.value);

            if (isNaN(amount) || amount <= 0) {
                showModal('Error de Abono', 'Por favor, introduce un monto de abono válido y positivo.');
                return;
            }

            addPayment(projectId, amount);
            showNotification(`Abono de $${amount.toFixed(2)} registrado.`, 'success');
            amountInput.value = ''; // Limpiar campo
        }

        function updateProjectStatus(projectId, newStatus) {
            const project = state.projects.find(p => p.id === projectId);
            if (project) {
                project.status = newStatus;
                saveProject(project); // Usa saveProject para actualizar y guardar
                showNotification(`Estado de proyecto actualizado a: ${newStatus}`, 'success');
            }
        }

        async function handleThumbnailUpload(projectId) {
            const fileInput = document.getElementById('thumbnail-upload');
            const file = fileInput.files[0];

            if (!file) return;

            // Redimensionar y convertir a Base64 antes de guardar
            const base64Image = await resizeImageAndConvertToBase64(file);

            if (base64Image) {
                const project = state.projects.find(p => p.id === projectId);
                if (project) {
                    project.thumbnailBase64 = base64Image;
                    saveProject(project);
                    showNotification('Miniatura cargada exitosamente.', 'success');
                }
            } else {
                showModal('Error de Imagen', 'No se pudo procesar la miniatura.');
            }
        }

        async function removeThumbnail(projectId) {
            const project = state.projects.find(p => p.id === projectId);
            if (project && await showModal('Confirmar Eliminación', '¿Estás segura de que quieres eliminar la miniatura de avance?', true)) {
                project.thumbnailBase64 = null;
                saveProject(project);
                showNotification('Miniatura eliminada.', 'success');
            }
        }

        /**
         * Abre el modal de edición del cliente.
         */
        async function openEditClientModal(clientId) {
            const client = state.clients.find(c => c.id === clientId);
            if (!client) return;

            const content = `
                <form id="edit-client-form">
                    <div class="mb-4">
                        <label for="edit-name" class="block text-sm font-medium text-gray-700">Nombre (Obligatorio)</label>
                        <input type="text" id="edit-name" value="${client.name}" required class="mt-1 block w-full p-2 border border-gray-300 rounded-md">
                    </div>
                    <div class="mb-4">
                        <label for="edit-whatsapp" class="block text-sm font-medium text-gray-700">WhatsApp (Obligatorio)</label>
                        <input type="text" id="edit-whatsapp" value="${client.whatsapp_number}" required class="mt-1 block w-full p-2 border border-gray-300 rounded-md">
                    </div>
                    <div class="mb-4">
                        <label for="edit-email" class="block text-sm font-medium text-gray-700">Correo Electrónico</label>
                        <input type="email" id="edit-email" value="${client.email || ''}" class="mt-1 block w-full p-2 border border-gray-300 rounded-md">
                    </div>
                    <div class="mb-4 flex items-center">
                        <input type="checkbox" id="edit-is-active" ${client.isActive ? 'checked' : ''} class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                        <label for="edit-is-active" class="ml-2 block text-sm font-medium text-gray-700">Cliente Activo (Aparece en Dashboard)</label>
                    </div>
                    <p class="text-sm text-gray-500 mt-2">La foto de perfil solo se puede actualizar creando un nuevo cliente por ahora.</p>
                </form>
            `;

            showModal('Editar Cliente: ' + client.name, content, true).then(confirmed => {
                if (confirmed) {
                    const newName = document.getElementById('edit-name').value.trim();
                    const newWhatsapp = document.getElementById('edit-whatsapp').value.trim();
                    const newEmail = document.getElementById('edit-email').value.trim();
                    const newIsActive = document.getElementById('edit-is-active').checked;

                    if (!newName || !newWhatsapp) {
                        showModal('Error de Edición', 'Nombre y WhatsApp son obligatorios.');
                        return;
                    }

                    saveClient({
                        id: clientId,
                        name: newName,
                        whatsapp_number: newWhatsapp,
                        email: newEmail,
                        isActive: newIsActive
                    });
                    showNotification('Cliente actualizado.', 'success');
                }
            });
        }


        function openEditProjectModal(projectId) {
            const project = state.projects.find(p => p.id === projectId);
            if (!project) return;

            // Simulación de un modal para editar campos
            showModal(
                'Editar Detalles del Proyecto',
                `
                 <div class="mb-4">
                    <label for="edit-name" class="block text-sm font-medium text-gray-700">Nombre</label>
                    <input type="text" id="edit-name" value="${project.name}" class="mt-1 block w-full p-2 border border-gray-300 rounded-md">
                 </div>
                 <div class="mb-4">
                    <label for="edit-price" class="block text-sm font-medium text-gray-700">Precio Total</label>
                    <input type="number" step="0.01" id="edit-price" value="${project.totalPrice}" class="mt-1 block w-full p-2 border border-gray-300 rounded-md">
                 </div>
                 <div class="mb-4">
                    <label for="edit-description" class="block text-sm font-medium text-gray-700">Descripción/Notas</label>
                    <textarea id="edit-description" rows="5" class="mt-1 block w-full p-2 border border-gray-300 rounded-md">${project.description}</textarea>
                 </div>
                 <div class="mb-4">
                    <label for="edit-delivery-date" class="block text-sm font-medium text-gray-700">Fecha de Entrega</label>
                    <input type="date" id="edit-delivery-date" value="${project.deliveryDate ? project.deliveryDate.substring(0, 10) : ''}" class="mt-1 block w-full p-2 border border-gray-300 rounded-md">
                 </div>
                 `,
                'Guardar', 'Cancelar' // Etiquetas personalizadas para el modal
            ).then(confirmed => {
                if (confirmed) {
                    const newName = document.getElementById('edit-name').value;
                    const newPrice = document.getElementById('edit-price').value;
                    const newDescription = document.getElementById('edit-description').value;
                    const newDeliveryDate = document.getElementById('edit-delivery-date').value || null;

                    if (!newName || !newPrice || !newDescription) {
                        showModal('Error de Edición', 'Nombre, Precio y Descripción son obligatorios.');
                        return;
                    }

                    project.name = newName;
                    project.totalPrice = parseFloat(newPrice).toFixed(2);
                    project.description = newDescription;
                    project.deliveryDate = newDeliveryDate;

                    saveProject(project);
                    showNotification('Proyecto actualizado.', 'success');
                }
            });
        }


        async function deleteProject(projectId) {
            const project = state.projects.find(p => p.id === projectId);
            if (!project) return;

            if (await showModal('Confirmar Eliminación', `¿Estás segura de eliminar el proyecto "${project.name}"? Esta acción no se puede deshacer.`, true)) {
                // Eliminar proyecto
                state.projects = state.projects.filter(p => p.id !== projectId);
                // Eliminar pagos asociados
                state.payments = state.payments.filter(p => p.projectId !== projectId);

                saveData();
                showNotification('Proyecto eliminado.', 'success');
                navigate('client_detail', project.clientId); // Volver al detalle del cliente
            }
        }

        async function deleteClient(clientId) {
            const client = state.clients.find(c => c.id === clientId);
            if (!client) return;

            if (await showModal('Confirmar Eliminación', `¿Estás segura de eliminar al cliente "${client.name}" y TODOS sus proyectos asociados? Esta acción no se puede deshacer.`, true)) {
                // Proyectos a eliminar
                const projectsToDelete = state.projects.filter(p => p.clientId === clientId);
                const projectIdsToDelete = projectsToDelete.map(p => p.id);

                // Eliminar pagos
                state.payments = state.payments.filter(p => !projectIdsToDelete.includes(p.projectId));
                // Eliminar proyectos
                state.projects = state.projects.filter(p => p.clientId !== clientId);
                // Eliminar cliente
                state.clients = state.clients.filter(c => c.id !== clientId);

                saveData();
                showNotification('Cliente y proyectos eliminados.', 'success');
                navigate('client_list'); // Volver a la lista de clientes
            }
        }


        function saveSetting(status, message) {
            state.settings[status] = message;
            saveData();
        }

        function handleSearch(event) {
            state.searchTerm = event.target.value;

            if (state.currentView === 'client_list') {
                renderClientList();
            } else if (state.currentView === 'dashboard') {
                renderDashboard();
            }
        }


        /**
         * Función principal de renderizado (Router).
         */
        function renderApp() {
            console.log(`Renderizando vista: ${state.currentView}`);
            switch (state.currentView) {
                case 'dashboard':
                    renderDashboard();
                    break;
                case 'client_list':
                    renderClientList();
                    break;
                case 'client_detail':
                    renderClientDetail(state.currentClientId);
                    break;
                case 'project_detail':
                    renderProjectDetail(state.currentProjectId);
                    break;
                case 'create_client':
                    renderCreateClientOnlyForm();
                    break;
                case 'create_project':
                    renderCreateProjectForm(state.currentClientId);
                    break;
                case 'settings':
                    renderSettings();
                    break;
                default:
                    renderDashboard();
            }
        }

        // ====================================================================
        // 7. INICIALIZACIÓN
        // ====================================================================
        window.onload = () => {
            loadData();
            // Aseguramos que los estilos de navegación se apliquen en la carga inicial
            updateActiveClass(state.currentView);
            renderApp();
        };

        // Función auxiliar para inicializar la pestaña (se llama al cargar client_detail)
        window.switchProjectTab = switchProjectTab;

    </script>
</body>

</html>